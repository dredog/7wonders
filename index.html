<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>7 Wonders Duel</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { 
            font-family: 'Cinzel', serif;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg,#2c1810,#6b4423);
        }
        #root { height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
const { useState, useEffect } = React;

const AGE1_CARDS = [
  { id: 'a1_1', name: 'Lumber Yard', type: 'brown', cost: {}, prod: { wood: 1 }},
  { id: 'a1_2', name: 'Clay Pool', type: 'brown', cost: {}, prod: { clay: 1 }},
  { id: 'a1_3', name: 'Quarry', type: 'brown', cost: {}, prod: { stone: 1 }},
  { id: 'a1_4', name: 'Logging Camp', type: 'brown', cost: { coin: 1 }, prod: { wood: 1 }},
  { id: 'a1_5', name: 'Clay Pit', type: 'brown', cost: { coin: 1 }, prod: { clay: 1 }},
  { id: 'a1_6', name: 'Stone Pit', type: 'brown', cost: { coin: 1 }, prod: { stone: 1 }},
  { id: 'a1_7', name: 'Glassworks', type: 'gray', cost: { coin: 1 }, prod: { glass: 1 }},
  { id: 'a1_8', name: 'Press', type: 'gray', cost: { coin: 1 }, prod: { papyrus: 1 }},
  { id: 'a1_9', name: 'Guard Tower', type: 'red', cost: {}, mil: 1 },
  { id: 'a1_10', name: 'Stable', type: 'red', cost: { wood: 1 }, mil: 1 },
  { id: 'a1_11', name: 'Garrison', type: 'red', cost: { clay: 1 }, mil: 1 },
  { id: 'a1_12', name: 'Palisade', type: 'red', cost: { coin: 2 }, mil: 1 },
  { id: 'a1_13', name: 'Baths', type: 'blue', cost: { stone: 1 }, pts: 3 },
  { id: 'a1_14', name: 'Altar', type: 'blue', cost: {}, pts: 3 },
  { id: 'a1_15', name: 'Theater', type: 'blue', cost: {}, pts: 3 },
  { id: 'a1_16', name: 'Workshop', type: 'green', cost: { papyrus: 1 }, sci: 'gear', pts: 1 },
  { id: 'a1_17', name: 'Apothecary', type: 'green', cost: { glass: 1 }, sci: 'wheel', pts: 1 },
  { id: 'a1_18', name: 'Scriptorium', type: 'green', cost: { coin: 2 }, sci: 'tablet', pts: 1 },
  { id: 'a1_19', name: 'Tavern', type: 'yellow', cost: {}, coins: 4 },
  { id: 'a1_20', name: 'Stone Reserve', type: 'yellow', cost: { coin: 3 }, fixedTrade: 'stone' }
];

const AGE2_CARDS = [
  { id: 'a2_1', name: 'Sawmill', type: 'brown', cost: { coin: 2 }, prod: { wood: 2 }},
  { id: 'a2_2', name: 'Brickyard', type: 'brown', cost: { coin: 2 }, prod: { clay: 2 }},
  { id: 'a2_3', name: 'Shelf Quarry', type: 'brown', cost: { coin: 2 }, prod: { stone: 2 }},
  { id: 'a2_4', name: 'Glassblower', type: 'gray', cost: {}, prod: { glass: 1 }},
  { id: 'a2_5', name: 'Drying Room', type: 'gray', cost: {}, prod: { papyrus: 1 }},
  { id: 'a2_6', name: 'Walls', type: 'red', cost: { stone: 2 }, mil: 2 },
  { id: 'a2_7', name: 'Horse Breeders', type: 'red', cost: { clay: 1, wood: 1 }, mil: 1 },
  { id: 'a2_8', name: 'Barracks', type: 'red', cost: { coin: 3 }, mil: 1 },
  { id: 'a2_9', name: 'Archery Range', type: 'red', cost: { stone: 1, wood: 1, papyrus: 1 }, mil: 2 },
  { id: 'a2_10', name: 'Parade Ground', type: 'red', cost: { clay: 2, glass: 1 }, mil: 2 },
  { id: 'a2_11', name: 'Courthouse', type: 'blue', cost: { wood: 2, glass: 1 }, pts: 5 },
  { id: 'a2_12', name: 'Statue', type: 'blue', cost: { clay: 2 }, pts: 4 },
  { id: 'a2_13', name: 'Temple', type: 'blue', cost: { wood: 1, papyrus: 1 }, pts: 4 },
  { id: 'a2_14', name: 'Aqueduct', type: 'blue', cost: { stone: 3 }, pts: 5 },
  { id: 'a2_15', name: 'Rostrum', type: 'blue', cost: { stone: 1, wood: 1 }, pts: 4 },
  { id: 'a2_16', name: 'Library', type: 'green', cost: { stone: 1, wood: 1, glass: 1 }, sci: 'tablet', pts: 2 },
  { id: 'a2_17', name: 'Dispensary', type: 'green', cost: { clay: 2, stone: 1 }, sci: 'wheel', pts: 2 },
  { id: 'a2_18', name: 'Laboratory', type: 'green', cost: { wood: 1, glass: 2 }, sci: 'gear', pts: 2 },
  { id: 'a2_19', name: 'Forum', type: 'yellow', cost: { coin: 3, clay: 1 }, prod: { glass: 1, papyrus: 1 }},
  { id: 'a2_20', name: 'Caravansery', type: 'yellow', cost: { coin: 2, glass: 1, papyrus: 1 }, prod: { wood: 1, clay: 1, stone: 1 }}
];

const AGE3_CARDS = [
  { id: 'a3_1', name: 'Arsenal', type: 'red', cost: { clay: 3, wood: 2 }, mil: 3 },
  { id: 'a3_2', name: 'Pretorium', type: 'red', cost: { coin: 8 }, mil: 3 },
  { id: 'a3_3', name: 'Fortifications', type: 'red', cost: { stone: 2, clay: 1, papyrus: 1 }, mil: 2 },
  { id: 'a3_4', name: 'Siege Workshop', type: 'red', cost: { wood: 3, glass: 1 }, mil: 2 },
  { id: 'a3_5', name: 'Circus', type: 'red', cost: { clay: 2, stone: 2 }, mil: 2 },
  { id: 'a3_6', name: 'Palace', type: 'blue', cost: { clay: 1, stone: 1, wood: 1, glass: 2 }, pts: 7 },
  { id: 'a3_7', name: 'Town Hall', type: 'blue', cost: { stone: 3, wood: 2 }, pts: 7 },
  { id: 'a3_8', name: 'Obelisk', type: 'blue', cost: { stone: 2, glass: 1 }, pts: 5 },
  { id: 'a3_9', name: 'Gardens', type: 'blue', cost: { clay: 2, wood: 2 }, pts: 6 },
  { id: 'a3_10', name: 'Pantheon', type: 'blue', cost: { clay: 1, wood: 1, papyrus: 2 }, pts: 6 },
  { id: 'a3_11', name: 'Senate', type: 'blue', cost: { clay: 2, stone: 1, papyrus: 1 }, pts: 5 },
  { id: 'a3_12', name: 'Academy', type: 'green', cost: { stone: 1, wood: 1, glass: 2 }, sci: 'sundial', pts: 3 },
  { id: 'a3_13', name: 'Study', type: 'green', cost: { wood: 2, glass: 1, papyrus: 1 }, sci: 'sundial', pts: 3 },
  { id: 'a3_14', name: 'University', type: 'green', cost: { clay: 1, glass: 1, papyrus: 1 }, sci: 'globe', pts: 2 },
  { id: 'a3_15', name: 'Observatory', type: 'green', cost: { stone: 1, papyrus: 2 }, sci: 'globe', pts: 2 },
  { id: 'a3_16', name: 'Armory', type: 'purple', cost: { stone: 2, glass: 1 }, coins: 1, ptsPer: { type: 'red', value: 1, label: '1â˜…/ğŸ”´' }},
  { id: 'a3_17', name: 'Lighthouse', type: 'purple', cost: { clay: 2, glass: 1 }, coins: 1, ptsPer: { type: 'yellow', value: 1, label: '1â˜…/ğŸŸ¡' }},
  { id: 'a3_18', name: 'Arena', type: 'purple', cost: { clay: 1, stone: 1, wood: 1 }, coins: 2, ptsPer: { type: 'wonder', value: 2, label: '2â˜…/ğŸ›' }},
  { id: 'a3_19', name: 'Chamber of Commerce', type: 'purple', cost: { papyrus: 2 }, coins: 3, ptsPer: { type: 'gray', value: 3, label: '3â˜…/âšª' }},
  { id: 'a3_20', name: 'Port', type: 'purple', cost: { wood: 1, glass: 1, papyrus: 1 }, coins: 2, ptsPer: { type: 'brown', value: 2, label: '2â˜…/ğŸŸ¤' }}
];

const WONDERS = [
  { id: 'w1', name: 'Pyramids', cost: { stone: 3 }, pts: 9 },
  { id: 'w2', name: 'Lighthouse', cost: { wood: 1, stone: 1, papyrus: 1 }, pts: 4, prod: { wood: 1, clay: 1, stone: 1 }},
  { id: 'w3', name: 'Artemis', cost: { wood: 1, stone: 1, glass: 1, papyrus: 1 }, pts: 0, coins: 12, extraTurn: true },
  { id: 'w4', name: 'Zeus', cost: { clay: 1, wood: 1, stone: 1, papyrus: 2 }, pts: 3, mil: 1 },
  { id: 'w5', name: 'Mausoleum', cost: { clay: 2, glass: 2, papyrus: 1 }, pts: 2 },
  { id: 'w6', name: 'Colossus', cost: { clay: 3, glass: 1 }, pts: 3, mil: 2 },
  { id: 'w7', name: 'Library', cost: { wood: 3, glass: 1, papyrus: 1 }, pts: 4 },
  { id: 'w8', name: 'Circus Max', cost: { stone: 2, wood: 1, glass: 1 }, pts: 3, mil: 1 },
  { id: 'w9', name: 'Piraeus', cost: { wood: 2, stone: 1, clay: 1 }, pts: 2, extraTurn: true },
  { id: 'w10', name: 'Appian Way', cost: { clay: 2, stone: 2, papyrus: 1 }, pts: 3, coins: 3, opponentLoses: 3, extraTurn: true },
  { id: 'w11', name: 'Sphinx', cost: { stone: 1, clay: 1, glass: 2 }, pts: 6, extraTurn: true },
  { id: 'w12', name: 'Gardens', cost: { wood: 2, glass: 1, papyrus: 1 }, pts: 3, coins: 6, extraTurn: true }
];

const COLORS = { brown: '#8b4513', gray: '#708090', red: '#c41e3a', green: '#228b22', blue: '#1e90ff', yellow: '#daa520', purple: '#8b008b' };
const RES = { wood: 'ğŸªµ', clay: 'ğŸ§±', stone: 'ğŸª¨', glass: 'ğŸ”®', papyrus: 'ğŸ“œ', coin: 'ğŸ’°' };

const buildAge1 = (cards) => {
  const s = [...cards].sort(() => Math.random() - 0.5);
  return [
    {r:0,c:0,card:s[0],up:true,taken:false},{r:0,c:1,card:s[1],up:true,taken:false},
    {r:1,c:0,card:s[2],up:false,taken:false},{r:1,c:1,card:s[3],up:false,taken:false},{r:1,c:2,card:s[4],up:false,taken:false},
    {r:2,c:0,card:s[5],up:true,taken:false},{r:2,c:1,card:s[6],up:true,taken:false},{r:2,c:2,card:s[7],up:true,taken:false},{r:2,c:3,card:s[8],up:true,taken:false},
    {r:3,c:0,card:s[9],up:false,taken:false},{r:3,c:1,card:s[10],up:false,taken:false},{r:3,c:2,card:s[11],up:false,taken:false},{r:3,c:3,card:s[12],up:false,taken:false},{r:3,c:4,card:s[13],up:false,taken:false},
    {r:4,c:0,card:s[14],up:true,taken:false},{r:4,c:1,card:s[15],up:true,taken:false},{r:4,c:2,card:s[16],up:true,taken:false},{r:4,c:3,card:s[17],up:true,taken:false},{r:4,c:4,card:s[18],up:true,taken:false},{r:4,c:5,card:s[19],up:true,taken:false}
  ];
};

const buildAge2 = (cards) => {
  const s = [...cards].sort(() => Math.random() - 0.5);
  return [
    {r:0,c:0,card:s[0],up:true,taken:false},{r:0,c:1,card:s[1],up:true,taken:false},
    {r:1,c:0,card:s[2],up:false,taken:false},{r:1,c:1,card:s[3],up:false,taken:false},{r:1,c:2,card:s[4],up:false,taken:false},
    {r:2,c:0,card:s[5],up:true,taken:false},{r:2,c:1,card:s[6],up:true,taken:false},{r:2,c:2,card:s[7],up:true,taken:false},{r:2,c:3,card:s[8],up:true,taken:false},
    {r:3,c:0,card:s[9],up:false,taken:false},{r:3,c:1,card:s[10],up:false,taken:false},{r:3,c:2,card:s[11],up:false,taken:false},{r:3,c:3,card:s[12],up:false,taken:false},{r:3,c:4,card:s[13],up:false,taken:false},
    {r:4,c:0,card:s[14],up:true,taken:false},{r:4,c:1,card:s[15],up:true,taken:false},{r:4,c:2,card:s[16],up:true,taken:false},{r:4,c:3,card:s[17],up:true,taken:false},{r:4,c:4,card:s[18],up:true,taken:false},{r:4,c:5,card:s[19],up:true,taken:false}
  ];
};

const buildAge3 = (cards) => {
  const s = [...cards].sort(() => Math.random() - 0.5);
  return [
    {r:0,c:0,card:s[0],up:true,taken:false},{r:0,c:5,card:s[1],up:true,taken:false},
    {r:1,c:0,card:s[2],up:false,taken:false},{r:1,c:1,card:s[3],up:false,taken:false},{r:1,c:4,card:s[4],up:false,taken:false},{r:1,c:5,card:s[5],up:false,taken:false},
    {r:2,c:0,card:s[6],up:true,taken:false},{r:2,c:1,card:s[7],up:true,taken:false},{r:2,c:2,card:s[8],up:true,taken:false},{r:2,c:3,card:s[9],up:true,taken:false},{r:2,c:4,card:s[10],up:true,taken:false},{r:2,c:5,card:s[11],up:true,taken:false},
    {r:3,c:0,card:s[12],up:false,taken:false},{r:3,c:1,card:s[13],up:false,taken:false},{r:3,c:2,card:s[14],up:false,taken:false},{r:3,c:3,card:s[15],up:false,taken:false},{r:3,c:4,card:s[16],up:false,taken:false},
    {r:4,c:0,card:s[17],up:true,taken:false},{r:4,c:2,card:s[18],up:true,taken:false},{r:4,c:4,card:s[19],up:true,taken:false}
  ];
};

function App() {
  const [game, setGame] = useState(null);
  const [sel, setSel] = useState(null);
  const [msg, setMsg] = useState(null);
  const [wonderMode, setWonderMode] = useState(null);
  const [vsAI, setVsAI] = useState(false);
  const [aiThinking, setAiThinking] = useState(false);
  const [showCards, setShowCards] = useState(null);

  const start = (ai) => {
    const sw = [...WONDERS].sort(() => Math.random() - 0.5);
    setVsAI(ai);
    setGame({
      age: 1, pyr: buildAge1(AGE1_CARDS),
      p1: { coins: 7, cards: [], wonders: sw.slice(0,4).map(w => ({...w, built: false})) },
      p2: { coins: 7, cards: [], wonders: sw.slice(4,8).map(w => ({...w, built: false})) },
      turn: 1, military: 0, discard: [], wondersBuilt: 0, winner: null
    });
    setSel(null); setMsg(null); setWonderMode(null); setAiThinking(false); setShowCards(null);
  };

  const nextAge = () => {
    const next = game.age + 1;
    const pyr = next === 2 ? buildAge2(AGE2_CARDS) : buildAge3(AGE3_CARDS);
    const first = game.military < 0 ? 1 : game.military > 0 ? 2 : game.turn;
    setGame({...game, age: next, pyr, turn: first});
    setSel(null); setMsg(`Age ${next}! P${first} starts`); setWonderMode(null);
  };

  const getProd = (cards, wonders) => {
    const p = {};
    cards?.forEach(c => c?.prod && Object.entries(c.prod).forEach(([k,v]) => p[k] = (p[k]||0) + v));
    wonders?.forEach(w => w?.built && w?.prod && Object.entries(w.prod).forEach(([k,v]) => p[k] = (p[k]||0) + v));
    return p;
  };

  const calcCost = (cost, myP, oppP) => {
    if (!cost || !Object.keys(cost).length) return { c: 0, d: 'Free' };
    let t = cost.coin || 0;
    const d = cost.coin ? [`${cost.coin}ğŸ’°`] : [];
    ['wood','clay','stone','glass','papyrus'].forEach(r => {
      const need = cost[r] || 0;
      if (need > 0) {
        const buy = Math.max(0, need - (myP[r]||0));
        if (buy > 0) { const tr = buy * (2 + (oppP[r]||0)); t += tr; d.push(`${buy}${RES[r]}=${tr}ğŸ’°`); }
      }
    });
    return { c: t, d: d.length ? d.join('+') : 'Free' };
  };

  const applyMil = (cur, shields, player) => {
    const dir = player === 1 ? 1 : -1;
    let m = cur + shields * dir, lost = 0, win = false, victor = null;
    if (player === 1) {
      if (cur < 3 && m >= 3) lost = 2;
      if (cur < 6 && m >= 6) lost = 5;
      if (m >= 9) { m = 9; win = true; victor = 1; }
    } else {
      if (cur > -3 && m <= -3) lost = 2;
      if (cur > -6 && m <= -6) lost = 5;
      if (m <= -9) { m = -9; win = true; victor = 2; }
    }
    return { m, lost, win, victor };
  };

  const isAcc = (pyr, pos, age) => {
    if (!pos || pos.taken) return false;
    if (age === 2) {
      return !pyr.some(p => p.r === pos.r - 1 && (p.c === pos.c || p.c === pos.c - 1) && !p.taken);
    }
    return !pyr.some(p => p.r === pos.r + 1 && (p.c === pos.c || p.c === pos.c + 1) && !p.taken);
  };

  const reveal = (pyr, taken, age) => pyr.map(p => {
    if (p === taken) return {...p, taken: true};
    if (p.up || p.taken) return p;
    if (age === 2) {
      const above = pyr.filter(b => b.r === p.r - 1 && (b.c === p.c || b.c === p.c - 1));
      if (above.every(b => b === taken || b.taken)) return {...p, up: true};
    } else {
      const below = pyr.filter(b => b.r === p.r + 1 && (b.c === p.c || b.c === p.c + 1));
      if (below.every(b => b === taken || b.taken)) return {...p, up: true};
    }
    return p;
  });

  const getYellow = (p) => p?.cards?.filter(c => c.type === 'yellow').length || 0;

  const build = () => {
    if (!sel || !game || game.winner) return;
    const p = game.turn === 1 ? game.p1 : game.p2;
    const o = game.turn === 1 ? game.p2 : game.p1;
    const cc = calcCost(sel.card.cost, getProd(p.cards, p.wonders), getProd(o.cards, o.wonders));
    if (p.coins < cc.c) { setMsg(`Need ${cc.c}ğŸ’°`); return; }
    const newCoins = p.coins - cc.c + (sel.card.coins || 0);
    let mil = { m: game.military, lost: 0, win: false, victor: null };
    if (sel.card.mil) mil = applyMil(game.military, sel.card.mil, game.turn);
    const newO = {...o, coins: Math.max(0, o.coins - mil.lost)};
    if (mil.lost) setMsg(`P${game.turn===1?2:1} -${mil.lost}ğŸ’°`);
    else setMsg(null);
    setGame({...game, pyr: reveal(game.pyr, sel, game.age),
      p1: game.turn === 1 ? {...p, coins: newCoins, cards: [...p.cards, sel.card]} : newO,
      p2: game.turn === 2 ? {...p, coins: newCoins, cards: [...p.cards, sel.card]} : newO,
      turn: game.turn === 1 ? 2 : 1, military: mil.m, winner: mil.win ? mil.victor : null
    });
    setSel(null);
  };

  const discard = () => {
    if (!sel || !game || game.winner) return;
    const p = game.turn === 1 ? game.p1 : game.p2;
    const val = 2 + getYellow(p);
    setGame({...game, pyr: reveal(game.pyr, sel, game.age),
      p1: game.turn === 1 ? {...p, coins: p.coins + val} : game.p1,
      p2: game.turn === 2 ? {...p, coins: p.coins + val} : game.p2,
      turn: game.turn === 1 ? 2 : 1, discard: [...game.discard, sel.card]
    });
    setSel(null); setMsg(`+${val}ğŸ’°`);
  };

  const buildW = () => {
    if (!sel || !wonderMode || !game || game.winner) return;
    const p = game.turn === 1 ? game.p1 : game.p2;
    const o = game.turn === 1 ? game.p2 : game.p1;
    const cc = calcCost(wonderMode.cost, getProd(p.cards, p.wonders), getProd(o.cards, o.wonders));
    if (p.coins < cc.c) { setMsg(`Need ${cc.c}ğŸ’°`); return; }
    if (game.wondersBuilt >= 7) { setMsg('Max 7!'); return; }
    const newCoins = p.coins - cc.c + (wonderMode.coins || 0);
    const newW = p.wonders.map(w => w.id === wonderMode.id ? {...w, built: true} : w);
    let mil = { m: game.military, lost: 0, win: false, victor: null };
    if (wonderMode.mil) mil = applyMil(game.military, wonderMode.mil, game.turn);
    const newO = {...o, coins: Math.max(0, o.coins - mil.lost - (wonderMode.opponentLoses||0))};
    const next = wonderMode.extraTurn ? game.turn : (game.turn === 1 ? 2 : 1);
    setMsg(`${wonderMode.name}!${wonderMode.extraTurn ? ' Again!' : ''}`);
    setGame({...game, pyr: reveal(game.pyr, sel, game.age),
      p1: game.turn === 1 ? {...p, coins: newCoins, wonders: newW} : newO,
      p2: game.turn === 2 ? {...p, coins: newCoins, wonders: newW} : newO,
      turn: next, military: mil.m, wondersBuilt: game.wondersBuilt + 1, winner: mil.win ? mil.victor : null
    });
    setSel(null); setWonderMode(null);
  };

  const getPts = (p) => {
    let pts = 0;
    p.cards?.forEach(c => {
      pts += c.pts || 0;
      if (c.ptsPer) {
        let cnt = 0;
        if (c.ptsPer.type === 'wonder') cnt = p.wonders.filter(w => w.built).length;
        else cnt = p.cards.filter(x => x.type === c.ptsPer.type).length;
        pts += cnt * c.ptsPer.value;
      }
    });
    p.wonders?.forEach(w => { if (w.built) pts += w.pts || 0; });
    return pts;
  };

  const getMilPts = (m) => { const a = Math.abs(m); return a >= 6 ? 10 : a >= 3 ? 5 : a >= 1 ? 2 : 0; };

  // AI
  const evalCard = (card, p, o, mil) => {
    const cc = calcCost(card.cost, getProd(p.cards, p.wonders), getProd(o.cards, o.wonders));
    if (cc.c > p.coins) return -1000;
    let s = (card.pts||0) * 10 + (card.mil||0) * 8 + (card.coins||0) * 2;
    if (card.prod) s += Object.values(card.prod).reduce((a,v) => a + v * 5, 0);
    if (card.sci) s += 6;
    if (card.mil && mil <= -6) s += card.mil * 15;
    if (card.ptsPer) {
      const cnt = card.ptsPer.type === 'wonder' ? p.wonders.filter(w=>w.built).length : p.cards.filter(x=>x.type===card.ptsPer.type).length;
      s += cnt * card.ptsPer.value * 8;
    }
    return s - cc.c * 1.5;
  };

  const evalWonder = (w, p, o, mil) => {
    const cc = calcCost(w.cost, getProd(p.cards, p.wonders), getProd(o.cards, o.wonders));
    if (cc.c > p.coins) return -1000;
    let s = (w.pts||0) * 10 + (w.coins||0) * 2 + (w.mil||0) * 8;
    if (w.extraTurn) s += 12;
    if (w.opponentLoses) s += w.opponentLoses * 3;
    if (w.prod) s += Object.values(w.prod).reduce((a,v) => a + v * 4, 0);
    if (w.mil && mil <= -6) s += w.mil * 15;
    return s - cc.c * 1.5;
  };

  const aiTurn = (g) => {
    const p = g.p2, o = g.p1;
    const acc = g.pyr.filter(pos => !pos.taken && pos.up && isAcc(g.pyr, pos, g.age));
    if (!acc.length) return null;
    let best = null, bestS = -Infinity;
    acc.forEach(pos => {
      const s = evalCard(pos.card, p, o, g.military);
      if (s > bestS) { bestS = s; best = { t: 'build', pos }; }
    });
    const uw = p.wonders.filter(w => !w.built);
    if (uw.length && g.wondersBuilt < 7) {
      acc.forEach(pos => uw.forEach(w => {
        const s = evalWonder(w, p, o, g.military);
        if (s > bestS) { bestS = s; best = { t: 'wonder', pos, w }; }
      }));
    }
    if (bestS < 0) {
      let worst = acc[0], worstS = Infinity;
      acc.forEach(pos => { const s = evalCard(pos.card, p, o, g.military); if (s < worstS) { worstS = s; worst = pos; } });
      best = { t: 'discard', pos: worst };
    }
    return best;
  };

  const execAI = (a) => {
    if (!a || !game) return;
    const p = game.p2, o = game.p1, pos = a.pos;
    if (a.t === 'build') {
      const cc = calcCost(pos.card.cost, getProd(p.cards, p.wonders), getProd(o.cards, o.wonders));
      let mil = { m: game.military, lost: 0, win: false, victor: null };
      if (pos.card.mil) mil = applyMil(game.military, pos.card.mil, 2);
      const newO = {...o, coins: Math.max(0, o.coins - mil.lost)};
      setMsg(`AI: ${pos.card.name}${mil.lost ? ` P1 -${mil.lost}ğŸ’°` : ''}`);
      setGame({...game, pyr: reveal(game.pyr, pos, game.age), p1: newO,
        p2: {...p, coins: p.coins - cc.c + (pos.card.coins||0), cards: [...p.cards, pos.card]},
        turn: 1, military: mil.m, winner: mil.win ? mil.victor : null
      });
    } else if (a.t === 'wonder') {
      const w = a.w;
      const cc = calcCost(w.cost, getProd(p.cards, p.wonders), getProd(o.cards, o.wonders));
      let mil = { m: game.military, lost: 0, win: false, victor: null };
      if (w.mil) mil = applyMil(game.military, w.mil, 2);
      const newO = {...o, coins: Math.max(0, o.coins - mil.lost - (w.opponentLoses||0))};
      const next = w.extraTurn ? 2 : 1;
      setMsg(`AI: ${w.name}${w.extraTurn ? ' Again!' : ''}`);
      setGame({...game, pyr: reveal(game.pyr, pos, game.age), p1: newO,
        p2: {...p, coins: p.coins - cc.c + (w.coins||0), wonders: p.wonders.map(ww => ww.id === w.id ? {...ww, built: true} : ww)},
        turn: next, military: mil.m, wondersBuilt: game.wondersBuilt + 1, winner: mil.win ? mil.victor : null
      });
    } else {
      const val = 2 + getYellow(p);
      setMsg(`AI discarded +${val}ğŸ’°`);
      setGame({...game, pyr: reveal(game.pyr, pos, game.age), p2: {...p, coins: p.coins + val}, turn: 1, discard: [...game.discard, pos.card]});
    }
  };

  useEffect(() => {
    if (!game || !vsAI || game.turn !== 2 || game.winner) return;
    if (!game.pyr.some(p => !p.taken)) return;
    setAiThinking(true);
    const t = setTimeout(() => { const a = aiTurn(game); if (a) execAI(a); setAiThinking(false); }, 800);
    return () => clearTimeout(t);
  }, [game, vsAI]);

  if (!game) {
    return (
      <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',color:'#f4e4c1'}}>
        <div style={{textAlign:'center'}}>
          <h1 style={{fontSize:'2.5rem',marginBottom:'10px'}}>7 Wonders Duel</h1>
          <p style={{marginBottom:'30px',color:'#c9a227',fontSize:'1.1rem'}}>A civilization card game</p>
          <button onClick={() => start(false)} style={{display:'block',margin:'10px auto',padding:'15px 40px',fontSize:'1.2rem',background:'linear-gradient(135deg,#8b6914,#c9a227)',border:'2px solid #f4e4c1',borderRadius:'10px',color:'#2c1810',fontWeight:'bold',cursor:'pointer',width:'200px'}}>2 Players</button>
          <button onClick={() => start(true)} style={{display:'block',margin:'10px auto',padding:'15px 40px',fontSize:'1.2rem',background:'linear-gradient(135deg,#1a5c1a,#2a8c2a)',border:'2px solid #f4e4c1',borderRadius:'10px',color:'#fff',fontWeight:'bold',cursor:'pointer',width:'200px'}}>vs AI ğŸ¤–</button>
        </div>
      </div>
    );
  }

  const left = game.pyr.filter(p => !p.taken).length;
  const cur = game.turn === 1 ? game.p1 : game.p2;
  const opp = game.turn === 1 ? game.p2 : game.p1;
  const curProd = getProd(cur.cards, cur.wonders);
  const oppProd = getProd(opp.cards, opp.wonders);
  const done = left === 0 && !game.winner;
  const aiTurn = vsAI && game.turn === 2 && !game.winner && !done;

  const Card = ({card, pos, small, inPyr}) => {
    const acc = inPyr && isAcc(game.pyr, pos, game.age);
    const canClick = inPyr && acc && !game.winner && !aiTurn;
    const cc = inPyr ? calcCost(card.cost, curProd, oppProd) : null;
    const w = small ? 50 : 70;
    const h = small ? 70 : 95;
    
    return (
      <div onClick={() => canClick && (setSel(pos), setWonderMode(null))} style={{
        width: w, height: h, background: COLORS[card.type], borderRadius: 6,
        border: sel === pos ? '3px solid gold' : inPyr && acc ? '2px solid #ffd700' : '2px solid rgba(0,0,0,0.3)',
        cursor: canClick ? 'pointer' : 'default', opacity: inPyr && !acc ? 0.5 : 1,
        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
        padding: 3, color: '#fff', textAlign: 'center', boxShadow: sel === pos ? '0 0 10px gold' : '0 2px 4px rgba(0,0,0,0.3)',
        fontSize: small ? '0.65rem' : '0.75rem', fontWeight: 'bold', position: 'relative'
      }}>
        <div style={{fontSize: small ? '0.55rem' : '0.65rem', marginBottom: 2, lineHeight: 1.1}}>{card.name}</div>
        <div style={{fontSize: small ? '1rem' : '1.3rem', lineHeight: 1}}>
          {card.prod && Object.entries(card.prod).map(([k,v]) => RES[k]).join('')}
          {card.pts ? `â˜…${card.pts}` : ''}
          {card.mil ? `âš”ï¸${card.mil}` : ''}
          {card.sci ? 'ğŸ”¬' : ''}
          {card.coins && card.type === 'yellow' ? `+${card.coins}ğŸ’°` : ''}
        </div>
        {card.ptsPer && <div style={{fontSize: '0.6rem', background: 'rgba(255,255,255,0.2)', padding: '1px 3px', borderRadius: 3, marginTop: 2}}>{card.ptsPer.label}</div>}
        {inPyr && acc && cc && <div style={{position: 'absolute', bottom: 2, fontSize: '0.6rem', color: cur.coins >= cc.c ? '#8f8' : '#f88'}}>{cc.c}ğŸ’°</div>}
      </div>
    );
  };

  const FaceDown = () => (
    <div style={{width: 70, height: 95, background: 'linear-gradient(135deg,#3a2414,#5a3a24)', border: '2px solid #666', borderRadius: 6, display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
      <span style={{fontSize: '2rem', color: '#c9a227'}}>?</span>
    </div>
  );

  const Empty = () => <div style={{width: 70, height: 95, background: 'rgba(255,255,255,0.05)', borderRadius: 6, border: '1px dashed rgba(255,255,255,0.1)'}}></div>;

  const Wonder = ({w, pNum}) => {
    const isSel = wonderMode?.id === w.id;
    const canSel = game.turn === pNum && sel && !w.built && !(vsAI && pNum === 2) && game.wondersBuilt < 7;
    const cc = calcCost(w.cost, curProd, oppProd);
    return (
      <div onClick={() => canSel && setWonderMode(w)} style={{
        width: 90, height: 65, background: w.built ? '#333' : 'linear-gradient(135deg,#4a0080,#800080)',
        border: isSel ? '3px solid gold' : w.built ? '2px solid #555' : '2px solid #a80',
        borderRadius: 6, padding: 4, color: '#fff', opacity: w.built ? 0.6 : 1,
        cursor: canSel ? 'pointer' : 'default', boxShadow: isSel ? '0 0 8px gold' : 'none',
        display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', textAlign: 'center'
      }}>
        <div style={{fontSize: '0.6rem', fontWeight: 'bold', marginBottom: 2}}>{w.name}</div>
        {w.built ? <div style={{color: '#8f8', fontSize: '0.9rem'}}>âœ“</div> : <>
          <div style={{fontSize: '0.9rem'}}>{w.pts > 0 && `â˜…${w.pts}`}{w.mil ? `âš”ï¸${w.mil}` : ''}{w.coins ? `+${w.coins}ğŸ’°` : ''}{w.extraTurn ? 'ğŸ”„' : ''}</div>
          {sel && canSel && <div style={{fontSize: '0.55rem', color: cur.coins >= cc.c ? '#8f8' : '#f88'}}>{cc.c}ğŸ’°</div>}
        </>}
      </div>
    );
  };

  const Player = ({pNum}) => {
    const p = pNum === 1 ? game.p1 : game.p2;
    const active = game.turn === pNum;
    const label = vsAI ? (pNum === 1 ? 'You' : 'AIğŸ¤–') : `P${pNum}`;
    const milB = (pNum === 1 && game.military > 0) || (pNum === 2 && game.military < 0);
    return (
      <div style={{background: 'rgba(0,0,0,0.4)', border: active ? '3px solid gold' : '2px solid #555', borderRadius: 8, padding: 8, flex: 1, minWidth: 0}}>
        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4}}>
          <span style={{fontWeight: 'bold', fontSize: '1.1rem'}}>{label}</span>
          <span style={{fontSize: '1.1rem'}}>ğŸ’°{p.coins} â˜…{getPts(p)}{milB ? `+${getMilPts(game.military)}` : ''}</span>
        </div>
        <div style={{display: 'flex', gap: 4, overflowX: 'auto', paddingBottom: 4}}>
          {p.wonders.map(w => <Wonder key={w.id} w={w} pNum={pNum} />)}
        </div>
        <div style={{display: 'flex', alignItems: 'center', gap: 8, marginTop: 4}}>
          <span style={{fontSize: '0.8rem', color: '#c9a227'}}>ğŸƒ{p.cards.length}</span>
          <button onClick={() => setShowCards(showCards === pNum ? null : pNum)} style={{padding: '2px 8px', background: showCards === pNum ? '#c9a227' : '#555', border: 'none', borderRadius: 4, color: '#fff', cursor: 'pointer', fontSize: '0.75rem'}}>
            {showCards === pNum ? 'Hide' : 'Show'}
          </button>
          <span style={{fontSize: '0.75rem', color: '#888'}}>+{2+getYellow(p)}ğŸ’°/discard</span>
        </div>
        {showCards === pNum && p.cards.length > 0 && (
          <div style={{display: 'flex', gap: 3, marginTop: 6, flexWrap: 'wrap'}}>
            {p.cards.map((c,i) => <Card key={i} card={c} small />)}
          </div>
        )}
      </div>
    );
  };

  const MilTrack = () => {
    const pos = [];
    for (let i = -9; i <= 9; i++) pos.push(i);
    return (
      <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 1, padding: '6px 0'}}>
        <span style={{fontSize: '0.8rem', marginRight: 4, color: '#6af'}}>{vsAI ? 'AI' : 'P2'}</span>
        {pos.map(p => {
          const tok = game.military === p;
          const ms = Math.abs(p) === 3 || Math.abs(p) === 6;
          const cap = Math.abs(p) === 9;
          return (
            <div key={p} style={{
              width: cap ? 26 : ms ? 22 : 14, height: 28,
              background: p === 0 ? '#555' : p < 0 ? (cap ? '#004' : ms ? '#258' : '#234') : (cap ? '#400' : ms ? '#852' : '#432'),
              border: tok ? '2px solid gold' : '1px solid #444', borderRadius: 3,
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              fontSize: tok ? '0.9rem' : '0.6rem', color: '#fff', boxShadow: tok ? '0 0 6px gold' : 'none'
            }}>
              {tok ? 'âš”ï¸' : ms ? (Math.abs(p) === 3 ? '2' : '5') : cap ? 'â˜ ï¸' : ''}
            </div>
          );
        })}
        <span style={{fontSize: '0.8rem', marginLeft: 4, color: '#fa6'}}>{vsAI ? 'You' : 'P1'}</span>
      </div>
    );
  };

  const Pyramid = () => {
    const rows = [0,1,2,3,4];
    const cardW = 70, cardH = 95, overlapX = 38, overlapY = 55;
    
    // Calculate positions
    const positions = game.pyr.map(pos => {
      let x, y;
      if (game.age === 3) {
        // Age 3 special layout
        const baseX = pos.c * overlapX;
        y = pos.r * overlapY;
        x = baseX;
      } else {
        // Age 1 & 2: offset each row
        const rowCards = game.pyr.filter(p => p.r === pos.r);
        const minC = Math.min(...rowCards.map(p => p.c));
        const maxC = Math.max(...rowCards.map(p => p.c));
        const rowWidth = (maxC - minC) * overlapX + cardW;
        const totalWidth = 5 * overlapX + cardW;
        const offsetX = (totalWidth - rowWidth) / 2;
        x = offsetX + (pos.c - minC) * overlapX;
        y = pos.r * overlapY;
      }
      return { ...pos, x, y };
    });

    const maxY = Math.max(...positions.map(p => p.y)) + cardH;
    const maxX = Math.max(...positions.map(p => p.x)) + cardW;

    return (
      <div style={{position: 'relative', width: maxX, height: maxY, margin: '0 auto'}}>
        {positions.map((pos, i) => (
          <div key={i} style={{position: 'absolute', left: pos.x, top: pos.y, zIndex: pos.r * 10 + pos.c}}>
            {pos.taken ? <Empty /> : !pos.up ? <FaceDown /> : <Card card={pos.card} pos={pos} inPyr />}
          </div>
        ))}
      </div>
    );
  };

  const Actions = () => {
    if (!sel || game.winner || done || aiTurn) return null;
    const cc = calcCost(sel.card.cost, curProd, oppProd);
    const yellow = getYellow(cur);
    
    if (wonderMode) {
      return (
        <div style={{background: 'rgba(100,50,0,0.8)', border: '2px solid gold', borderRadius: 8, padding: 10, display: 'flex', alignItems: 'center', gap: 10, flexWrap: 'wrap', justifyContent: 'center'}}>
          <span style={{fontSize: '0.9rem'}}>Build <b>{wonderMode.name}</b> with {sel.card.name}</span>
          <button onClick={buildW} style={{padding: '8px 16px', background: '#808', border: '2px solid #fff', borderRadius: 6, color: '#fff', fontWeight: 'bold', cursor: 'pointer', fontSize: '1rem'}}>âœ“ Build</button>
          <button onClick={() => setWonderMode(null)} style={{padding: '8px 16px', background: '#666', border: '2px solid #fff', borderRadius: 6, color: '#fff', cursor: 'pointer'}}>Cancel</button>
        </div>
      );
    }
    
    return (
      <div style={{background: 'rgba(100,50,0,0.8)', border: '2px solid gold', borderRadius: 8, padding: 10, display: 'flex', alignItems: 'center', gap: 10, flexWrap: 'wrap', justifyContent: 'center'}}>
        <span style={{fontSize: '0.9rem'}}><b>{sel.card.name}</b> ({cc.d})</span>
        <button onClick={build} style={{padding: '8px 16px', background: '#282', border: '2px solid #fff', borderRadius: 6, color: '#fff', fontWeight: 'bold', cursor: 'pointer', fontSize: '1rem'}}>âœ“ Build</button>
        <button onClick={discard} style={{padding: '8px 16px', background: '#555', border: '2px solid #fff', borderRadius: 6, color: '#fff', cursor: 'pointer'}}>Discard +{2+yellow}ğŸ’°</button>
        <button onClick={() => setSel(null)} style={{padding: '8px 16px', background: '#733', border: '2px solid #fff', borderRadius: 6, color: '#fff', cursor: 'pointer'}}>Cancel</button>
      </div>
    );
  };

  const EndScreen = () => {
    if (!game.winner && !done) return null;
    const p1T = getPts(game.p1) + (game.military > 0 ? getMilPts(game.military) : 0);
    const p2T = getPts(game.p2) + (game.military < 0 ? getMilPts(game.military) : 0);
    let winner;
    if (game.winner) winner = game.winner;
    else winner = p1T > p2T ? 1 : p2T > p1T ? 2 : 0;
    
    if (done && game.age < 3) {
      return (
        <div style={{position: 'absolute', inset: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100}}>
          <div style={{background: 'linear-gradient(135deg,#3a2414,#6b4423)', border: '3px solid gold', borderRadius: 12, padding: 30, textAlign: 'center', color: '#f4e4c1'}}>
            <h2 style={{margin: '0 0 15px', fontSize: '1.8rem'}}>Age {game.age} Complete!</h2>
            <p style={{fontSize: '1.2rem', margin: '10px 0'}}>{vsAI ? 'You' : 'P1'}: {getPts(game.p1)}â˜… | {vsAI ? 'AI' : 'P2'}: {getPts(game.p2)}â˜…</p>
            <button onClick={nextAge} style={{marginTop: 15, padding: '12px 30px', fontSize: '1.2rem', background: 'linear-gradient(135deg,#8b6914,#c9a227)', border: '2px solid #fff', borderRadius: 8, color: '#2c1810', fontWeight: 'bold', cursor: 'pointer'}}>Begin Age {game.age + 1} â†’</button>
          </div>
        </div>
      );
    }
    
    return (
      <div style={{position: 'absolute', inset: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100}}>
        <div style={{background: 'linear-gradient(135deg,#3a2414,#6b4423)', border: '3px solid gold', borderRadius: 12, padding: 30, textAlign: 'center', color: '#f4e4c1', maxWidth: 400}}>
          <h2 style={{margin: '0 0 15px', fontSize: '1.8rem'}}>{game.winner ? 'âš”ï¸ Military Victory!' : 'ğŸ† Game Over!'}</h2>
          <p style={{fontSize: '1.1rem', margin: '8px 0'}}>{vsAI ? 'You' : 'P1'}: {getPts(game.p1)}â˜… {game.military > 0 ? `+${getMilPts(game.military)}âš”ï¸` : ''} = <b>{p1T}</b></p>
          <p style={{fontSize: '1.1rem', margin: '8px 0'}}>{vsAI ? 'AI' : 'P2'}: {getPts(game.p2)}â˜… {game.military < 0 ? `+${getMilPts(game.military)}âš”ï¸` : ''} = <b>{p2T}</b></p>
          <p style={{fontSize: '1.5rem', color: 'gold', margin: '20px 0'}}>
            {winner === 0 ? "It's a tie!" : (vsAI ? (winner === 1 ? 'ğŸ‰ You Win!' : 'ğŸ¤– AI Wins!') : `Player ${winner} Wins!`)}
          </p>
          <button onClick={() => setGame(null)} style={{padding: '12px 30px', fontSize: '1.2rem', background: 'linear-gradient(135deg,#8b6914,#c9a227)', border: '2px solid #fff', borderRadius: 8, color: '#2c1810', fontWeight: 'bold', cursor: 'pointer'}}>Play Again</button>
        </div>
      </div>
    );
  };

  return (
    <div style={{height: '100%', display: 'flex', flexDirection: 'column', color: '#f4e4c1', overflow: 'hidden', position: 'relative'}}>
      {/* Header */}
      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 12px', background: 'rgba(0,0,0,0.3)', flexShrink: 0}}>
        <div style={{fontSize: '1.1rem', fontWeight: 'bold'}}>
          {aiThinking ? 'ğŸ¤– AI thinking...' : `Age ${game.age} â€¢ ${vsAI ? (game.turn === 1 ? 'Your turn' : 'AI turn') : `P${game.turn}'s turn`}`}
        </div>
        <div style={{display: 'flex', alignItems: 'center', gap: 10}}>
          <span style={{fontSize: '0.9rem', color: '#c9a227'}}>ğŸƒ{left} ğŸ›{game.wondersBuilt}/7</span>
          <button onClick={() => setGame(null)} style={{padding: '4px 10px', background: '#8b4513', border: '1px solid #c9a227', borderRadius: 4, color: '#fff', cursor: 'pointer'}}>Menu</button>
        </div>
      </div>

      {/* Message */}
      {msg && <div style={{textAlign: 'center', padding: '6px', background: 'rgba(201,162,39,0.3)', fontSize: '0.9rem', flexShrink: 0}}>{msg} <span onClick={() => setMsg(null)} style={{cursor: 'pointer', marginLeft: 10}}>âœ•</span></div>}

      {/* Military */}
      <div style={{flexShrink: 0}}><MilTrack /></div>

      {/* Players */}
      <div style={{display: 'flex', gap: 8, padding: '0 8px', flexShrink: 0}}>
        <Player pNum={1} />
        <Player pNum={2} />
      </div>

      {/* Pyramid */}
      <div style={{flex: 1, display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', padding: 10, minHeight: 0, overflow: 'auto'}}>
        <div style={{fontSize: '0.85rem', color: '#c9a227', marginBottom: 6}}>Age {game.age} {game.age === 2 && '(Topâ†’Bottom)'}</div>
        <Pyramid />
      </div>

      {/* Actions */}
      <div style={{flexShrink: 0, padding: '8px'}}><Actions /></div>

      {/* End Screen */}
      <EndScreen />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
