<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 Wonders Duel</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; font-family: 'Cinzel', serif; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
const { useState, useEffect } = React;

const AGE1_CARDS = [
  { id: 'a1_1', name: 'Lumber Yard', type: 'brown', cost: {}, prod: { wood: 1 }},
  { id: 'a1_2', name: 'Clay Pool', type: 'brown', cost: {}, prod: { clay: 1 }},
  { id: 'a1_3', name: 'Quarry', type: 'brown', cost: {}, prod: { stone: 1 }},
  { id: 'a1_4', name: 'Logging Camp', type: 'brown', cost: { coin: 1 }, prod: { wood: 1 }},
  { id: 'a1_5', name: 'Clay Pit', type: 'brown', cost: { coin: 1 }, prod: { clay: 1 }},
  { id: 'a1_6', name: 'Stone Pit', type: 'brown', cost: { coin: 1 }, prod: { stone: 1 }},
  { id: 'a1_7', name: 'Glassworks', type: 'gray', cost: { coin: 1 }, prod: { glass: 1 }},
  { id: 'a1_8', name: 'Press', type: 'gray', cost: { coin: 1 }, prod: { papyrus: 1 }},
  { id: 'a1_9', name: 'Guard Tower', type: 'red', cost: {}, mil: 1 },
  { id: 'a1_10', name: 'Stable', type: 'red', cost: { wood: 1 }, mil: 1 },
  { id: 'a1_11', name: 'Garrison', type: 'red', cost: { clay: 1 }, mil: 1 },
  { id: 'a1_12', name: 'Palisade', type: 'red', cost: { coin: 2 }, mil: 1 },
  { id: 'a1_13', name: 'Baths', type: 'blue', cost: { stone: 1 }, pts: 3 },
  { id: 'a1_14', name: 'Altar', type: 'blue', cost: {}, pts: 3 },
  { id: 'a1_15', name: 'Theater', type: 'blue', cost: {}, pts: 3 },
  { id: 'a1_16', name: 'Workshop', type: 'green', cost: { papyrus: 1 }, sci: 'gear', pts: 1 },
  { id: 'a1_17', name: 'Apothecary', type: 'green', cost: { glass: 1 }, sci: 'wheel', pts: 1 },
  { id: 'a1_18', name: 'Scriptorium', type: 'green', cost: { coin: 2 }, sci: 'tablet', pts: 1 },
  { id: 'a1_19', name: 'Tavern', type: 'yellow', cost: {}, coins: 4 },
  { id: 'a1_20', name: 'Stone Reserve', type: 'yellow', cost: { coin: 3 }, fixedTrade: 'stone' }
];

const AGE2_CARDS = [
  { id: 'a2_1', name: 'Sawmill', type: 'brown', cost: { coin: 2 }, prod: { wood: 2 }},
  { id: 'a2_2', name: 'Brickyard', type: 'brown', cost: { coin: 2 }, prod: { clay: 2 }},
  { id: 'a2_3', name: 'Shelf Quarry', type: 'brown', cost: { coin: 2 }, prod: { stone: 2 }},
  { id: 'a2_4', name: 'Glassblower', type: 'gray', cost: {}, prod: { glass: 1 }},
  { id: 'a2_5', name: 'Drying Room', type: 'gray', cost: {}, prod: { papyrus: 1 }},
  { id: 'a2_6', name: 'Walls', type: 'red', cost: { stone: 2 }, mil: 2 },
  { id: 'a2_7', name: 'Horse Breeders', type: 'red', cost: { clay: 1, wood: 1 }, mil: 1 },
  { id: 'a2_8', name: 'Barracks', type: 'red', cost: { coin: 3 }, mil: 1 },
  { id: 'a2_9', name: 'Archery Range', type: 'red', cost: { stone: 1, wood: 1, papyrus: 1 }, mil: 2 },
  { id: 'a2_10', name: 'Parade Ground', type: 'red', cost: { clay: 2, glass: 1 }, mil: 2 },
  { id: 'a2_11', name: 'Courthouse', type: 'blue', cost: { wood: 2, glass: 1 }, pts: 5 },
  { id: 'a2_12', name: 'Statue', type: 'blue', cost: { clay: 2 }, pts: 4 },
  { id: 'a2_13', name: 'Temple', type: 'blue', cost: { wood: 1, papyrus: 1 }, pts: 4 },
  { id: 'a2_14', name: 'Aqueduct', type: 'blue', cost: { stone: 3 }, pts: 5 },
  { id: 'a2_15', name: 'Rostrum', type: 'blue', cost: { stone: 1, wood: 1 }, pts: 4 },
  { id: 'a2_16', name: 'Library', type: 'green', cost: { stone: 1, wood: 1, glass: 1 }, sci: 'tablet', pts: 2 },
  { id: 'a2_17', name: 'Dispensary', type: 'green', cost: { clay: 2, stone: 1 }, sci: 'wheel', pts: 2 },
  { id: 'a2_18', name: 'Laboratory', type: 'green', cost: { wood: 1, glass: 2 }, sci: 'gear', pts: 2 },
  { id: 'a2_19', name: 'Forum', type: 'yellow', cost: { coin: 3, clay: 1 }, prod: { glass: 1, papyrus: 1 }},
  { id: 'a2_20', name: 'Caravansery', type: 'yellow', cost: { coin: 2, glass: 1, papyrus: 1 }, prod: { wood: 1, clay: 1, stone: 1 }}
];

const AGE3_CARDS = [
  { id: 'a3_1', name: 'Arsenal', type: 'red', cost: { clay: 3, wood: 2 }, mil: 3 },
  { id: 'a3_2', name: 'Pretorium', type: 'red', cost: { coin: 8 }, mil: 3 },
  { id: 'a3_3', name: 'Fortifications', type: 'red', cost: { stone: 2, clay: 1, papyrus: 1 }, mil: 2 },
  { id: 'a3_4', name: 'Siege Workshop', type: 'red', cost: { wood: 3, glass: 1 }, mil: 2 },
  { id: 'a3_5', name: 'Circus', type: 'red', cost: { clay: 2, stone: 2 }, mil: 2 },
  { id: 'a3_6', name: 'Palace', type: 'blue', cost: { clay: 1, stone: 1, wood: 1, glass: 2 }, pts: 7 },
  { id: 'a3_7', name: 'Town Hall', type: 'blue', cost: { stone: 3, wood: 2 }, pts: 7 },
  { id: 'a3_8', name: 'Obelisk', type: 'blue', cost: { stone: 2, glass: 1 }, pts: 5 },
  { id: 'a3_9', name: 'Gardens', type: 'blue', cost: { clay: 2, wood: 2 }, pts: 6 },
  { id: 'a3_10', name: 'Pantheon', type: 'blue', cost: { clay: 1, wood: 1, papyrus: 2 }, pts: 6 },
  { id: 'a3_11', name: 'Senate', type: 'blue', cost: { clay: 2, stone: 1, papyrus: 1 }, pts: 5 },
  { id: 'a3_12', name: 'Academy', type: 'green', cost: { stone: 1, wood: 1, glass: 2 }, sci: 'sundial', pts: 3 },
  { id: 'a3_13', name: 'Study', type: 'green', cost: { wood: 2, glass: 1, papyrus: 1 }, sci: 'sundial', pts: 3 },
  { id: 'a3_14', name: 'University', type: 'green', cost: { clay: 1, glass: 1, papyrus: 1 }, sci: 'globe', pts: 2 },
  { id: 'a3_15', name: 'Observatory', type: 'green', cost: { stone: 1, papyrus: 2 }, sci: 'globe', pts: 2 },
  { id: 'a3_16', name: 'Armory', type: 'purple', cost: { stone: 2, glass: 1 }, coins: 1, ptsPer: { type: 'red', value: 1, label: '1‚òÖ/red' }},
  { id: 'a3_17', name: 'Lighthouse', type: 'purple', cost: { clay: 2, glass: 1 }, coins: 1, ptsPer: { type: 'yellow', value: 1, label: '1‚òÖ/yellow' }},
  { id: 'a3_18', name: 'Arena', type: 'purple', cost: { clay: 1, stone: 1, wood: 1 }, coins: 2, ptsPer: { type: 'wonder', value: 2, label: '2‚òÖ/wonder' }},
  { id: 'a3_19', name: 'Chamber of Commerce', type: 'purple', cost: { papyrus: 2 }, coins: 3, ptsPer: { type: 'gray', value: 3, label: '3‚òÖ/gray' }},
  { id: 'a3_20', name: 'Port', type: 'purple', cost: { wood: 1, glass: 1, papyrus: 1 }, coins: 2, ptsPer: { type: 'brown', value: 2, label: '2‚òÖ/brown' }}
];

const WONDERS = [
  { id: 'w1', name: 'The Pyramids', cost: { stone: 3 }, pts: 9 },
  { id: 'w2', name: 'Great Lighthouse', cost: { wood: 1, stone: 1, papyrus: 1 }, pts: 4, prod: { wood: 1, clay: 1, stone: 1 }},
  { id: 'w3', name: 'Temple of Artemis', cost: { wood: 1, stone: 1, glass: 1, papyrus: 1 }, pts: 0, coins: 12, extraTurn: true },
  { id: 'w4', name: 'Statue of Zeus', cost: { clay: 1, wood: 1, stone: 1, papyrus: 2 }, pts: 3, mil: 1 },
  { id: 'w5', name: 'The Mausoleum', cost: { clay: 2, glass: 2, papyrus: 1 }, pts: 2 },
  { id: 'w6', name: 'The Colossus', cost: { clay: 3, glass: 1 }, pts: 3, mil: 2 },
  { id: 'w7', name: 'Great Library', cost: { wood: 3, glass: 1, papyrus: 1 }, pts: 4 },
  { id: 'w8', name: 'Circus Maximus', cost: { stone: 2, wood: 1, glass: 1 }, pts: 3, mil: 1 },
  { id: 'w9', name: 'Piraeus', cost: { wood: 2, stone: 1, clay: 1 }, pts: 2, extraTurn: true },
  { id: 'w10', name: 'The Appian Way', cost: { clay: 2, stone: 2, papyrus: 1 }, pts: 3, coins: 3, opponentLoses: 3, extraTurn: true },
  { id: 'w11', name: 'The Sphinx', cost: { stone: 1, clay: 1, glass: 2 }, pts: 6, extraTurn: true },
  { id: 'w12', name: 'Hanging Gardens', cost: { wood: 2, glass: 1, papyrus: 1 }, pts: 3, coins: 6, extraTurn: true }
];

const COLORS = { brown: '#8b4513', gray: '#708090', red: '#b22222', green: '#228b22', blue: '#1e90ff', yellow: '#b8860b', purple: '#7b2d8e' };
const RES_ICON = { wood: 'ü™µ', clay: 'üß±', stone: 'ü™®', glass: 'üîÆ', papyrus: 'üìú', coin: 'üí∞' };

function buildAge1Pyramid(cards) {
  const shuffled = [...cards].sort(() => Math.random() - 0.5);
  return [
    { r: 0, c: 0, card: shuffled[0], up: true, taken: false },
    { r: 0, c: 1, card: shuffled[1], up: true, taken: false },
    { r: 1, c: 0, card: shuffled[2], up: false, taken: false },
    { r: 1, c: 1, card: shuffled[3], up: false, taken: false },
    { r: 1, c: 2, card: shuffled[4], up: false, taken: false },
    { r: 2, c: 0, card: shuffled[5], up: true, taken: false },
    { r: 2, c: 1, card: shuffled[6], up: true, taken: false },
    { r: 2, c: 2, card: shuffled[7], up: true, taken: false },
    { r: 2, c: 3, card: shuffled[8], up: true, taken: false },
    { r: 3, c: 0, card: shuffled[9], up: false, taken: false },
    { r: 3, c: 1, card: shuffled[10], up: false, taken: false },
    { r: 3, c: 2, card: shuffled[11], up: false, taken: false },
    { r: 3, c: 3, card: shuffled[12], up: false, taken: false },
    { r: 3, c: 4, card: shuffled[13], up: false, taken: false },
    { r: 4, c: 0, card: shuffled[14], up: true, taken: false },
    { r: 4, c: 1, card: shuffled[15], up: true, taken: false },
    { r: 4, c: 2, card: shuffled[16], up: true, taken: false },
    { r: 4, c: 3, card: shuffled[17], up: true, taken: false },
    { r: 4, c: 4, card: shuffled[18], up: true, taken: false },
    { r: 4, c: 5, card: shuffled[19], up: true, taken: false }
  ];
}

// Age 2: Inverted - 2 cards at top (row 0) accessible first, 6 cards at bottom
function buildAge2Pyramid(cards) {
  const shuffled = [...cards].sort(() => Math.random() - 0.5);
  return [
    { r: 0, c: 0, card: shuffled[0], up: true, taken: false },
    { r: 0, c: 1, card: shuffled[1], up: true, taken: false },
    { r: 1, c: 0, card: shuffled[2], up: false, taken: false },
    { r: 1, c: 1, card: shuffled[3], up: false, taken: false },
    { r: 1, c: 2, card: shuffled[4], up: false, taken: false },
    { r: 2, c: 0, card: shuffled[5], up: true, taken: false },
    { r: 2, c: 1, card: shuffled[6], up: true, taken: false },
    { r: 2, c: 2, card: shuffled[7], up: true, taken: false },
    { r: 2, c: 3, card: shuffled[8], up: true, taken: false },
    { r: 3, c: 0, card: shuffled[9], up: false, taken: false },
    { r: 3, c: 1, card: shuffled[10], up: false, taken: false },
    { r: 3, c: 2, card: shuffled[11], up: false, taken: false },
    { r: 3, c: 3, card: shuffled[12], up: false, taken: false },
    { r: 3, c: 4, card: shuffled[13], up: false, taken: false },
    { r: 4, c: 0, card: shuffled[14], up: true, taken: false },
    { r: 4, c: 1, card: shuffled[15], up: true, taken: false },
    { r: 4, c: 2, card: shuffled[16], up: true, taken: false },
    { r: 4, c: 3, card: shuffled[17], up: true, taken: false },
    { r: 4, c: 4, card: shuffled[18], up: true, taken: false },
    { r: 4, c: 5, card: shuffled[19], up: true, taken: false }
  ];
}

function buildAge3Pyramid(cards) {
  const shuffled = [...cards].sort(() => Math.random() - 0.5);
  return [
    { r: 0, c: 0, card: shuffled[0], up: true, taken: false },
    { r: 0, c: 5, card: shuffled[1], up: true, taken: false },
    { r: 1, c: 0, card: shuffled[2], up: false, taken: false },
    { r: 1, c: 1, card: shuffled[3], up: false, taken: false },
    { r: 1, c: 4, card: shuffled[4], up: false, taken: false },
    { r: 1, c: 5, card: shuffled[5], up: false, taken: false },
    { r: 2, c: 0, card: shuffled[6], up: true, taken: false },
    { r: 2, c: 1, card: shuffled[7], up: true, taken: false },
    { r: 2, c: 2, card: shuffled[8], up: true, taken: false },
    { r: 2, c: 3, card: shuffled[9], up: true, taken: false },
    { r: 2, c: 4, card: shuffled[10], up: true, taken: false },
    { r: 2, c: 5, card: shuffled[11], up: true, taken: false },
    { r: 3, c: 0, card: shuffled[12], up: false, taken: false },
    { r: 3, c: 1, card: shuffled[13], up: false, taken: false },
    { r: 3, c: 2, card: shuffled[14], up: false, taken: false },
    { r: 3, c: 3, card: shuffled[15], up: false, taken: false },
    { r: 3, c: 4, card: shuffled[16], up: false, taken: false },
    { r: 4, c: 0, card: shuffled[17], up: true, taken: false },
    { r: 4, c: 2, card: shuffled[18], up: true, taken: false },
    { r: 4, c: 4, card: shuffled[19], up: true, taken: false }
  ];
}

function App() {
  const [game, setGame] = useState(null);
  const [sel, setSel] = useState(null);
  const [p1Expanded, setP1Expanded] = useState(false);
  const [p2Expanded, setP2Expanded] = useState(false);
  const [p1WondersExp, setP1WondersExp] = useState(true);
  const [p2WondersExp, setP2WondersExp] = useState(true);
  const [message, setMessage] = useState(null);
  const [wonderMode, setWonderMode] = useState(null);
  const [vsAI, setVsAI] = useState(false);
  const [aiThinking, setAiThinking] = useState(false);

  const startGame = (playVsAI) => {
    const shuffledW = [...WONDERS].sort(() => Math.random() - 0.5);
    const p1W = shuffledW.slice(0, 4).map(w => ({ ...w, built: false }));
    const p2W = shuffledW.slice(4, 8).map(w => ({ ...w, built: false }));
    setVsAI(playVsAI);
    setGame({
      age: 1, pyr: buildAge1Pyramid(AGE1_CARDS),
      p1: { coins: 7, cards: [], wonders: p1W },
      p2: { coins: 7, cards: [], wonders: p2W },
      turn: 1, military: 0, discardPile: [], totalWondersBuilt: 0, winner: null
    });
    setSel(null); setMessage(null); setWonderMode(null); setAiThinking(false);
  };

  const startNextAge = () => {
    if (!game) return;
    const nextAge = game.age + 1;
    let newPyr = nextAge === 2 ? buildAge2Pyramid(AGE2_CARDS) : buildAge3Pyramid(AGE3_CARDS);
    const firstPlayer = game.military < 0 ? 1 : game.military > 0 ? 2 : game.turn;
    setGame({ ...game, age: nextAge, pyr: newPyr, turn: firstPlayer });
    setSel(null); setMessage(`Age ${nextAge} begins! Player ${firstPlayer} starts.`); setWonderMode(null);
  };

  const getProd = (cards, wonders) => {
    const prod = {};
    cards?.forEach(c => c?.prod && Object.entries(c.prod).forEach(([k, v]) => prod[k] = (prod[k] || 0) + v));
    wonders?.forEach(w => w?.built && w?.prod && Object.entries(w.prod).forEach(([k, v]) => prod[k] = (prod[k] || 0) + v));
    return prod;
  };

  const getProdDisplay = (prod) => {
    const keys = Object.keys(prod);
    return keys.length === 0 ? 'None' : keys.map(k => `${prod[k]}${RES_ICON[k] || k}`).join(' ');
  };

  const calcCost = (cost, myProd, oppProd) => {
    if (!cost || Object.keys(cost).length === 0) return { coinCost: 0, details: 'Free' };
    let total = cost.coin || 0;
    const details = [];
    if (cost.coin) details.push(`${cost.coin}üí∞`);
    ['wood', 'clay', 'stone', 'glass', 'papyrus'].forEach(res => {
      const need = cost[res] || 0;
      if (need > 0) {
        const have = myProd[res] || 0;
        const toBuy = Math.max(0, need - have);
        if (toBuy > 0) {
          const oppHas = oppProd[res] || 0;
          const trade = toBuy * (2 + oppHas);
          total += trade;
          details.push(`${toBuy}${RES_ICON[res]}=${trade}üí∞`);
        }
      }
    });
    return { coinCost: total, details: details.length > 0 ? details.join('+') : 'Free' };
  };

  const applyMil = (curMil, shields, curPlayer) => {
    const dir = curPlayer === 1 ? 1 : -1;
    let newMil = curMil + (shields * dir);
    let lost = 0, victory = false, victor = null;
    if (curPlayer === 1) {
      if (curMil < 3 && newMil >= 3) lost += 2;
      if (curMil < 6 && newMil >= 6) lost += 5;
      if (newMil >= 9) { newMil = 9; victory = true; victor = 1; }
    } else {
      if (curMil > -3 && newMil <= -3) lost += 2;
      if (curMil > -6 && newMil <= -6) lost += 5;
      if (newMil <= -9) { newMil = -9; victory = true; victor = 2; }
    }
    return { newMil, lost, victory, victor };
  };

  const isAccFn = (pyr, pos, age) => {
    if (!pos || pos.taken) return false;
    if (age === 2) {
      // Age 2: accessible from TOP - cards blocked by row ABOVE
      const dominated = pyr.filter(p => p.r === pos.r - 1 && (p.c === pos.c || p.c === pos.c - 1) && !p.taken);
      return dominated.length === 0;
    } else {
      // Age 1 & 3: accessible from bottom
      const dominated = pyr.filter(p => p.r === pos.r + 1 && (p.c === pos.c || p.c === pos.c + 1) && !p.taken);
      return dominated.length === 0;
    }
  };

  const isAcc = (pos) => game ? isAccFn(game.pyr, pos, game.age) : false;

  const revealFn = (pyr, takenPos, age) => pyr.map(p => {
    if (p === takenPos) return { ...p, taken: true };
    if (p.up || p.taken) return p;
    if (age === 2) {
      const above = pyr.filter(b => b.r === p.r - 1 && (b.c === p.c || b.c === p.c - 1));
      const allTaken = above.every(b => b === takenPos || b.taken);
      return allTaken ? { ...p, up: true } : p;
    } else {
      const below = pyr.filter(b => b.r === p.r + 1 && (b.c === p.c || b.c === p.c + 1));
      const allTaken = below.every(b => b === takenPos || b.taken);
      return allTaken ? { ...p, up: true } : p;
    }
  });

  const getYellowCount = (player) => player?.cards?.filter(c => c.type === 'yellow').length || 0;

  const buildCard = () => {
    if (!sel || !game || game.winner) return;
    const player = game.turn === 1 ? game.p1 : game.p2;
    const opp = game.turn === 1 ? game.p2 : game.p1;
    const myProd = getProd(player.cards, player.wonders);
    const oppProd = getProd(opp.cards, opp.wonders);
    const cc = calcCost(sel.card.cost, myProd, oppProd);
    if (player.coins < cc.coinCost) { setMessage(`Need ${cc.coinCost}üí∞, have ${player.coins}üí∞`); return; }

    const newCoins = player.coins - cc.coinCost + (sel.card.coins || 0);
    const newCards = [...player.cards, sel.card];
    let milRes = { newMil: game.military, lost: 0, victory: false, victor: null };
    if (sel.card.mil) milRes = applyMil(game.military, sel.card.mil, game.turn);
    
    const newOpp = { ...opp };
    if (milRes.lost > 0) {
      newOpp.coins = Math.max(0, opp.coins - milRes.lost);
      setMessage(`P${game.turn === 1 ? '2' : '1'} loses ${milRes.lost}üí∞!`);
    } else setMessage(null);

    const newPlayer = { ...player, coins: newCoins, cards: newCards };
    const newPyr = revealFn(game.pyr, sel, game.age);
    setGame({
      ...game, pyr: newPyr,
      p1: game.turn === 1 ? newPlayer : newOpp,
      p2: game.turn === 2 ? newPlayer : newOpp,
      turn: game.turn === 1 ? 2 : 1,
      military: milRes.newMil,
      winner: milRes.victory ? milRes.victor : null
    });
    setSel(null);
  };

  const discardCard = () => {
    if (!sel || !game || game.winner) return;
    const player = game.turn === 1 ? game.p1 : game.p2;
    const yellowCount = getYellowCount(player);
    const discardValue = 2 + yellowCount;
    const newPlayer = { ...player, coins: player.coins + discardValue };
    const newPyr = revealFn(game.pyr, sel, game.age);
    setGame({
      ...game, pyr: newPyr,
      p1: game.turn === 1 ? newPlayer : game.p1,
      p2: game.turn === 2 ? newPlayer : game.p2,
      turn: game.turn === 1 ? 2 : 1,
      discardPile: [...game.discardPile, sel.card]
    });
    setSel(null);
    setMessage(`+${discardValue}üí∞ (2 + ${yellowCount} yellow)`);
  };

  const selWonder = (w) => { if (sel && !w.built && game.totalWondersBuilt < 7) setWonderMode(w); };

  const buildWonder = () => {
    if (!sel || !wonderMode || !game || game.winner) return;
    const player = game.turn === 1 ? game.p1 : game.p2;
    const opp = game.turn === 1 ? game.p2 : game.p1;
    const myProd = getProd(player.cards, player.wonders);
    const oppProd = getProd(opp.cards, opp.wonders);
    const cc = calcCost(wonderMode.cost, myProd, oppProd);
    if (player.coins < cc.coinCost) { setMessage(`Need ${cc.coinCost}üí∞, have ${player.coins}üí∞`); return; }
    if (game.totalWondersBuilt >= 7) { setMessage('Max 7 wonders!'); return; }

    const newCoins = player.coins - cc.coinCost + (wonderMode.coins || 0);
    const newWonders = player.wonders.map(w => w.id === wonderMode.id ? { ...w, built: true } : w);
    let milRes = { newMil: game.military, lost: 0, victory: false, victor: null };
    if (wonderMode.mil) milRes = applyMil(game.military, wonderMode.mil, game.turn);
    
    const newOpp = { ...opp };
    if (milRes.lost > 0) newOpp.coins = Math.max(0, opp.coins - milRes.lost);
    if (wonderMode.opponentLoses) newOpp.coins = Math.max(0, newOpp.coins - wonderMode.opponentLoses);

    const newPlayer = { ...player, coins: newCoins, wonders: newWonders };
    const newPyr = revealFn(game.pyr, sel, game.age);
    const nextTurn = wonderMode.extraTurn ? game.turn : (game.turn === 1 ? 2 : 1);
    setGame({
      ...game, pyr: newPyr,
      p1: game.turn === 1 ? newPlayer : newOpp,
      p2: game.turn === 2 ? newPlayer : newOpp,
      turn: nextTurn, military: milRes.newMil,
      totalWondersBuilt: game.totalWondersBuilt + 1,
      winner: milRes.victory ? milRes.victor : null
    });
    setSel(null); setWonderMode(null);
    setMessage(`${wonderMode.name} built!${wonderMode.extraTurn ? ' Extra turn!' : ''}`);
  };

  const getPts = (player) => {
    let pts = 0;
    player.cards?.forEach(c => {
      pts += c.pts || 0;
      if (c.ptsPer) {
        let count = 0;
        if (c.ptsPer.type === 'red') count = player.cards.filter(x => x.type === 'red').length;
        else if (c.ptsPer.type === 'yellow') count = player.cards.filter(x => x.type === 'yellow').length;
        else if (c.ptsPer.type === 'brown') count = player.cards.filter(x => x.type === 'brown').length;
        else if (c.ptsPer.type === 'gray') count = player.cards.filter(x => x.type === 'gray').length;
        else if (c.ptsPer.type === 'wonder') count = player.wonders.filter(w => w.built).length;
        pts += count * c.ptsPer.value;
      }
    });
    player.wonders?.forEach(w => { if (w.built) pts += w.pts || 0; });
    return pts;
  };

  const getMilPts = (military) => {
    const absMil = Math.abs(military);
    if (absMil >= 6) return 10;
    if (absMil >= 3) return 5;
    if (absMil >= 1) return 2;
    return 0;
  };

  // AI Logic
  const evaluateCard = (card, player, opp, military) => {
    let score = 0;
    const myProd = getProd(player.cards, player.wonders);
    const oppProd = getProd(opp.cards, opp.wonders);
    const cc = calcCost(card.cost, myProd, oppProd);
    if (cc.coinCost > player.coins) return -1000;
    score += (card.pts || 0) * 10;
    if (card.mil) { score += card.mil * 8; if (military <= -6) score += card.mil * 15; }
    if (card.prod) score += Object.values(card.prod).reduce((s, v) => s + v * 5, 0);
    score += (card.coins || 0) * 2;
    if (card.sci) score += 6;
    if (card.ptsPer) {
      let count = 0;
      if (card.ptsPer.type === 'red') count = player.cards.filter(x => x.type === 'red').length;
      else if (card.ptsPer.type === 'yellow') count = player.cards.filter(x => x.type === 'yellow').length;
      else if (card.ptsPer.type === 'brown') count = player.cards.filter(x => x.type === 'brown').length;
      else if (card.ptsPer.type === 'gray') count = player.cards.filter(x => x.type === 'gray').length;
      else if (card.ptsPer.type === 'wonder') count = player.wonders.filter(w => w.built).length;
      score += count * card.ptsPer.value * 8;
    }
    score -= cc.coinCost * 1.5;
    return score;
  };

  const evaluateWonder = (wonder, player, opp, military) => {
    let score = 0;
    const myProd = getProd(player.cards, player.wonders);
    const oppProd = getProd(opp.cards, opp.wonders);
    const cc = calcCost(wonder.cost, myProd, oppProd);
    if (cc.coinCost > player.coins) return -1000;
    score += (wonder.pts || 0) * 10;
    score += (wonder.coins || 0) * 2;
    if (wonder.mil) { score += wonder.mil * 8; if (military <= -6) score += wonder.mil * 15; }
    if (wonder.extraTurn) score += 12;
    if (wonder.opponentLoses) score += wonder.opponentLoses * 3;
    if (wonder.prod) score += Object.values(wonder.prod).reduce((s, v) => s + v * 4, 0);
    score -= cc.coinCost * 1.5;
    return score;
  };

  const aiTakeTurn = (gameState) => {
    const player = gameState.p2, opp = gameState.p1, pyr = gameState.pyr, age = gameState.age;
    const accessible = pyr.filter(p => !p.taken && p.up && isAccFn(pyr, p, age));
    if (accessible.length === 0) return null;

    let bestAction = null, bestScore = -Infinity;
    accessible.forEach(pos => {
      const score = evaluateCard(pos.card, player, opp, gameState.military);
      if (score > bestScore) { bestScore = score; bestAction = { type: 'build', pos }; }
    });

    const unbuildWonders = player.wonders.filter(w => !w.built);
    if (unbuildWonders.length > 0 && gameState.totalWondersBuilt < 7) {
      accessible.forEach(pos => {
        unbuildWonders.forEach(w => {
          const wonderScore = evaluateWonder(w, player, opp, gameState.military);
          if (wonderScore > bestScore) { bestScore = wonderScore; bestAction = { type: 'wonder', pos, wonder: w }; }
        });
      });
    }

    if (bestScore < 0) {
      let worstPos = accessible[0], worstScore = Infinity;
      accessible.forEach(pos => {
        const cardScore = evaluateCard(pos.card, player, opp, gameState.military);
        if (cardScore < worstScore) { worstScore = cardScore; worstPos = pos; }
      });
      bestAction = { type: 'discard', pos: worstPos };
    }
    return bestAction;
  };

  const executeAIAction = (action) => {
    if (!action || !game) return;
    const player = game.p2, opp = game.p1, pos = action.pos;

    if (action.type === 'build') {
      const myProd = getProd(player.cards, player.wonders);
      const oppProd = getProd(opp.cards, opp.wonders);
      const cc = calcCost(pos.card.cost, myProd, oppProd);
      const newCoins = player.coins - cc.coinCost + (pos.card.coins || 0);
      const newCards = [...player.cards, pos.card];
      let milRes = { newMil: game.military, lost: 0, victory: false, victor: null };
      if (pos.card.mil) milRes = applyMil(game.military, pos.card.mil, 2);
      const newOpp = { ...opp };
      if (milRes.lost > 0) { newOpp.coins = Math.max(0, opp.coins - milRes.lost); setMessage(`AI built ${pos.card.name}. P1 loses ${milRes.lost}üí∞!`); }
      else setMessage(`AI built ${pos.card.name}`);
      const newPlayer = { ...player, coins: newCoins, cards: newCards };
      const newPyr = revealFn(game.pyr, pos, game.age);
      setGame({ ...game, pyr: newPyr, p1: newOpp, p2: newPlayer, turn: 1, military: milRes.newMil, winner: milRes.victory ? milRes.victor : null });
    } else if (action.type === 'wonder') {
      const w = action.wonder;
      const myProd = getProd(player.cards, player.wonders);
      const oppProd = getProd(opp.cards, opp.wonders);
      const cc = calcCost(w.cost, myProd, oppProd);
      const newCoins = player.coins - cc.coinCost + (w.coins || 0);
      const newWonders = player.wonders.map(ww => ww.id === w.id ? { ...ww, built: true } : ww);
      let milRes = { newMil: game.military, lost: 0, victory: false, victor: null };
      if (w.mil) milRes = applyMil(game.military, w.mil, 2);
      const newOpp = { ...opp };
      if (milRes.lost > 0) newOpp.coins = Math.max(0, opp.coins - milRes.lost);
      if (w.opponentLoses) newOpp.coins = Math.max(0, newOpp.coins - w.opponentLoses);
      const newPlayer = { ...player, coins: newCoins, wonders: newWonders };
      const newPyr = revealFn(game.pyr, pos, game.age);
      const nextTurn = w.extraTurn ? 2 : 1;
      setMessage(`AI built ${w.name}${w.extraTurn ? ' - Extra turn!' : ''}`);
      setGame({ ...game, pyr: newPyr, p1: newOpp, p2: newPlayer, turn: nextTurn, military: milRes.newMil, totalWondersBuilt: game.totalWondersBuilt + 1, winner: milRes.victory ? milRes.victor : null });
    } else if (action.type === 'discard') {
      const yellowCount = getYellowCount(player);
      const discardValue = 2 + yellowCount;
      const newPlayer = { ...player, coins: player.coins + discardValue };
      const newPyr = revealFn(game.pyr, pos, game.age);
      setMessage(`AI discarded ${pos.card.name} (+${discardValue}üí∞)`);
      setGame({ ...game, pyr: newPyr, p2: newPlayer, turn: 1, discardPile: [...game.discardPile, pos.card] });
    }
  };

  useEffect(() => {
    if (!game || !vsAI || game.turn !== 2 || game.winner) return;
    const cardsLeft = game.pyr.filter(p => !p.taken).length;
    if (cardsLeft === 0) return;
    setAiThinking(true);
    const timer = setTimeout(() => {
      const action = aiTakeTurn(game);
      if (action) executeAIAction(action);
      setAiThinking(false);
    }, 1000);
    return () => clearTimeout(timer);
  }, [game, vsAI]);

  if (!game) {
    return (
      <div style={{minHeight:'100vh',background:'linear-gradient(135deg,#2c1810,#6b4423)',display:'flex',alignItems:'center',justifyContent:'center',color:'#f4e4c1',padding:'20px'}}>
        <div style={{textAlign:'center'}}>
          <h1 style={{fontSize:'2.2rem',marginBottom:'20px'}}>7 Wonders Duel</h1>
          <p style={{marginBottom:'25px',color:'#c9a227'}}>A civilization-building card game</p>
          <div style={{display:'flex',flexDirection:'column',gap:'12px',alignItems:'center'}}>
            <button onClick={() => startGame(false)} style={{padding:'12px 35px',fontSize:'1.1rem',background:'linear-gradient(135deg,#8b6914,#c9a227)',border:'2px solid #f4e4c1',borderRadius:'8px',color:'#2c1810',fontWeight:'bold',cursor:'pointer',width:'220px'}}>2 Players</button>
            <button onClick={() => startGame(true)} style={{padding:'12px 35px',fontSize:'1.1rem',background:'linear-gradient(135deg,#1a5c1a,#2a8c2a)',border:'2px solid #f4e4c1',borderRadius:'8px',color:'#fff',fontWeight:'bold',cursor:'pointer',width:'220px'}}>vs AI ü§ñ</button>
          </div>
        </div>
      </div>
    );
  }

  const cardsLeft = game.pyr.filter(p => !p.taken).length;
  const curP = game.turn === 1 ? game.p1 : game.p2;
  const curOpp = game.turn === 1 ? game.p2 : game.p1;
  const curProd = getProd(curP.cards, curP.wonders);
  const oppProd = getProd(curOpp.cards, curOpp.wonders);
  const ageComplete = cardsLeft === 0 && !game.winner;
  const yellowCount = getYellowCount(curP);
  const isAITurn = vsAI && game.turn === 2 && !game.winner && !ageComplete;

  const milPositions = [];
  for (let mi = -9; mi <= 9; mi++) milPositions.push(mi);

  const renderCardContent = (card, isSmall) => {
    const titleSize = isSmall ? '0.6rem' : '0.7rem';
    const symbolSize = isSmall ? '1rem' : '1.2rem';
    const smallText = isSmall ? '0.55rem' : '0.6rem';
    return (
      <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-start',padding:'1px'}}>
        <div style={{fontWeight:'bold',fontSize:titleSize,marginBottom:'1px',textAlign:'center',lineHeight:1.1}}>{card.name}</div>
        {card.prod && <div style={{fontSize:symbolSize,lineHeight:1}}>{Object.entries(card.prod).map(([k,v]) => `${v>1?v:''}${RES_ICON[k]}`).join('')}</div>}
        <div style={{fontSize:symbolSize,lineHeight:1}}>{card.pts ? `‚òÖ${card.pts}` : ''}{card.mil ? `‚öî${card.mil}` : ''}{card.sci ? 'üî¨' : ''}</div>
        {card.type === 'yellow' && card.coins && <div style={{fontSize:symbolSize,lineHeight:1}}>+{card.coins}üí∞</div>}
        {card.type === 'purple' && <div style={{textAlign:'center'}}>
          {card.coins && <div style={{fontSize:'0.9rem'}}>+{card.coins}üí∞</div>}
          {card.ptsPer && <div style={{background:'rgba(255,255,255,0.25)',padding:'1px 3px',borderRadius:'3px',fontSize:smallText,border:'1px solid #fc0'}}>{card.ptsPer.label}</div>}
        </div>}
      </div>
    );
  };

  return (
    <div style={{minHeight:'100vh',background:'linear-gradient(135deg,#2c1810,#6b4423)',color:'#f4e4c1',padding:'15px',overflowX:'auto'}}>
      <div style={{maxWidth:'1300px',margin:'0 auto',minWidth:'850px'}}>
        
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px',flexWrap:'wrap',gap:'8px'}}>
          <h2 style={{margin:0,fontSize:'1.2rem'}}>
            {game.winner ? (vsAI && game.winner === 2 ? 'AI Wins!' : `Player ${game.winner} Wins!`) : (isAITurn ? `Age ${game.age} - AI Thinking...` : `Age ${game.age} - ${vsAI ? 'Your' : `Player ${game.turn}'s`} Turn`)}
            {vsAI && <span style={{marginLeft:'10px',fontSize:'0.8rem',color:'#2a8c2a'}}>ü§ñ vs AI</span>}
          </h2>
          <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
            <span style={{color:'#c9a227',fontSize:'0.85rem'}}>Cards:{cardsLeft} Wonders:{game.totalWondersBuilt}/7</span>
            <button onClick={() => setGame(null)} style={{padding:'5px 10px',background:'#8b4513',border:'2px solid #f4e4c1',borderRadius:'5px',color:'#fff',cursor:'pointer',fontSize:'0.85rem'}}>Menu</button>
          </div>
        </div>

        {aiThinking && <div style={{background:'rgba(42,140,42,0.3)',border:'2px solid #2a8c2a',borderRadius:'5px',padding:'10px',marginBottom:'12px',textAlign:'center',fontSize:'1rem'}}>ü§ñ AI is thinking...</div>}
        {message && !aiThinking && <div style={{background:'rgba(201,162,39,0.3)',border:'2px solid #c9a227',borderRadius:'5px',padding:'6px 12px',marginBottom:'12px',textAlign:'center',fontSize:'0.9rem'}}>{message}<button onClick={() => setMessage(null)} style={{marginLeft:'10px',padding:'1px 6px',background:'#666',border:'none',borderRadius:'3px',color:'#fff',cursor:'pointer'}}>‚úï</button></div>}

        <div style={{background:'rgba(0,0,0,0.3)',borderRadius:'8px',padding:'12px',marginBottom:'15px'}}>
          <div style={{textAlign:'center',marginBottom:'8px',fontSize:'0.9rem',fontWeight:'bold'}}>Military Track</div>
          <div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:'1px'}}>
            {milPositions.map(p => {
              const isTok = game.military === p;
              const isMS = Math.abs(p) === 3 || Math.abs(p) === 6;
              const isCap = Math.abs(p) === 9;
              const bg = p === 0 ? '#555' : p < 0 ? (isCap ? '#006' : isMS ? '#369' : '#335') : (isCap ? '#600' : isMS ? '#963' : '#533');
              return <div key={p} style={{width: isCap ? '28px' : isMS ? '24px' : '16px', height: '32px', background: bg, border: isTok ? '2px solid gold' : '1px solid #666', borderRadius: '3px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.55rem', color: '#fff', boxShadow: isTok ? '0 0 8px gold' : 'none'}}>{isTok && '‚öîÔ∏è'}{!isTok && isMS && (Math.abs(p) === 3 ? '2' : '5')}{!isTok && isCap && '‚ò†Ô∏è'}</div>;
            })}
          </div>
          <div style={{display:'flex',justifyContent:'space-between',marginTop:'4px',fontSize:'0.7rem'}}><span style={{color:'#6af'}}>‚Üê {vsAI ? 'AI' : 'P2'}</span><span style={{color:'#fa6'}}>{vsAI ? 'You' : 'P1'} ‚Üí</span></div>
        </div>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'12px'}}>
          {[1, 2].map(pNum => {
            const p = pNum === 1 ? game.p1 : game.p2;
            const isActive = game.turn === pNum;
            const expanded = pNum === 1 ? p1Expanded : p2Expanded;
            const setExpanded = pNum === 1 ? setP1Expanded : setP2Expanded;
            const wondersExp = pNum === 1 ? p1WondersExp : p2WondersExp;
            const setWondersExp = pNum === 1 ? setP1WondersExp : setP2WondersExp;
            const label = vsAI ? (pNum === 1 ? 'You' : 'AI ü§ñ') : `Player ${pNum}`;
            const milBonus = (pNum === 1 && game.military > 0) || (pNum === 2 && game.military < 0);
            
            return (
              <div key={pNum} style={{background:'rgba(0,0,0,0.3)',border:isActive?'3px solid gold':'2px solid #666',borderRadius:'8px',padding:'10px'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <h3 style={{margin:0,fontSize:'1rem'}}>{label}</h3>
                  <button onClick={() => setExpanded(!expanded)} style={{padding:'3px 6px',background:expanded?'#c9a227':'#555',border:'1px solid #888',borderRadius:'3px',color:'#fff',cursor:'pointer',fontSize:'0.7rem'}}>Cards({p.cards.length})</button>
                </div>
                <div style={{marginTop:'6px',fontSize:'0.85rem'}}>üí∞{p.coins} ‚òÖ{getPts(p)}{milBonus ? ` +${getMilPts(game.military)}‚öîÔ∏è` : ''}</div>
                <div style={{fontSize:'0.75rem',color:'#c9a227'}}>Prod: {getProdDisplay(getProd(p.cards, p.wonders))}</div>
                <div style={{fontSize:'0.7rem',color:'#daa520'}}>Yellow: {getYellowCount(p)} (Discard: +{2 + getYellowCount(p)}üí∞)</div>
                
                <div style={{marginTop:'6px'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <span style={{fontSize:'0.8rem',color:'#c9a227'}}>Wonders:</span>
                    <button onClick={() => setWondersExp(!wondersExp)} style={{padding:'1px 5px',background:'#555',border:'1px solid #888',borderRadius:'3px',color:'#fff',cursor:'pointer',fontSize:'0.65rem'}}>{wondersExp ? '‚ñº' : '‚ñ∂'}</button>
                  </div>
                  {wondersExp && <div style={{display:'flex',gap:'5px',marginTop:'6px',overflowX:'auto',paddingBottom:'4px'}}>
                    {p.wonders.map(w => {
                      const isSel = wonderMode && wonderMode.id === w.id;
                      const canSel = isActive && sel && !w.built && !(vsAI && pNum === 2);
                      const cc = calcCost(w.cost, curProd, oppProd);
                      return (
                        <div key={w.id} onClick={() => canSel && selWonder(w)} style={{width:'120px',minHeight:'100px',background:w.built?'#222':'linear-gradient(135deg,#408,#808)',border:isSel?'3px solid gold':w.built?'2px solid #444':'2px solid #a80',borderRadius:'6px',padding:'6px',color:'#fff',opacity:w.built?0.5:1,cursor:canSel?'pointer':'default',flexShrink:0,boxShadow:isSel?'0 0 12px gold':'none'}}>
                          <div style={{fontWeight:'bold',fontSize:'0.65rem',marginBottom:'4px'}}>{w.name}</div>
                          {w.built ? <div style={{color:'#8f8',fontSize:'0.65rem'}}>‚úì Built</div> : <div>
                            <div style={{fontSize:'0.55rem',color:'#ddd',marginBottom:'2px'}}>{Object.entries(w.cost).map(([k,v]) => `${v}${RES_ICON[k]||k}`).join(' ')}</div>
                            {sel && canSel && <div style={{fontSize:'0.55rem',color:curP.coins >= cc.coinCost ? '#8f8' : '#f88'}}>= {cc.coinCost}üí∞</div>}
                          </div>}
                          <div style={{fontSize:'0.55rem',marginTop:'4px',color:'#fc0'}}>{w.pts > 0 && `‚òÖ${w.pts} `}{w.mil && `‚öîÔ∏è${w.mil} `}{w.coins && `+${w.coins}üí∞ `}{w.extraTurn && 'üîÑ'}</div>
                        </div>
                      );
                    })}
                  </div>}
                </div>
                
                {expanded && p.cards.length > 0 && <div style={{marginTop:'8px',padding:'6px',background:'rgba(0,0,0,0.2)',borderRadius:'5px',overflowX:'auto'}}>
                  <div style={{display:'flex',gap:'4px',flexWrap:'wrap'}}>
                    {p.cards.map((c, i) => <div key={i} style={{width:'70px',minHeight:'85px',background:COLORS[c.type],border:'1px solid #c9a227',borderRadius:'4px',color:'#fff',textAlign:'center',fontSize:'0.55rem',flexShrink:0}}>{renderCardContent(c, true)}</div>)}
                  </div>
                </div>}
              </div>
            );
          })}
        </div>

        <div style={{background:'rgba(0,0,0,0.3)',borderRadius:'8px',padding:'12px',marginBottom:'12px',overflowX:'auto'}}>
          <div style={{textAlign:'center',marginBottom:'12px',fontWeight:'bold'}}>Age {game.age} Pyramid {game.age === 2 && '(Top ‚Üí Bottom)'}</div>
          <div style={{position:'relative',margin:'0 auto',width:'520px',height:'290px'}}>
            {game.pyr.map((pos, idx) => {
              const cardW = 75, cardH = 95;
              const overlapY = 50;
              
              // Calculate position - no horizontal overlap, just vertical
              const rowCards = game.pyr.filter(p => p.r === pos.r);
              const minC = Math.min(...rowCards.map(p => p.c));
              const maxC = Math.max(...rowCards.map(p => p.c));
              const rowWidth = (maxC - minC) * (cardW + 4) + cardW;
              const totalWidth = 520;
              const offsetX = (totalWidth - rowWidth) / 2;
              const x = offsetX + (pos.c - minC) * (cardW + 4);
              const y = pos.r * overlapY;
              
              const acc = isAcc(pos);
              const card = pos.card;
              const cc = calcCost(card.cost, curProd, oppProd);
              const canClick = acc && !game.winner && !isAITurn && !pos.taken && pos.up;
              
              if (pos.taken) {
                return <div key={idx} style={{position:'absolute',left:x,top:y,width:cardW,height:cardH,background:'rgba(255,255,255,0.05)',borderRadius:'6px',border:'1px dashed rgba(255,255,255,0.1)',zIndex:pos.r*10+pos.c}}></div>;
              }
              if (!pos.up) {
                return <div key={idx} style={{position:'absolute',left:x,top:y,width:cardW,height:cardH,background:'linear-gradient(135deg,#3a2414,#5a3a24)',border:'2px solid #666',borderRadius:'6px',display:'flex',alignItems:'flex-start',justifyContent:'center',paddingTop:'8px',zIndex:pos.r*10+pos.c}}><span style={{fontSize:'1.8rem',color:'#c9a227'}}>?</span></div>;
              }
              
              return (
                <div key={idx} onClick={() => canClick && (setSel(pos), setWonderMode(null))} style={{
                  position:'absolute',left:x,top:y,width:cardW,height:cardH,
                  background:COLORS[card.type],
                  border:sel===pos?'3px solid gold':acc?'2px solid #c9a227':'2px solid #555',
                  borderRadius:'6px',cursor:canClick?'pointer':'default',
                  opacity:acc?1:0.6,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-start',
                  padding:'4px 3px',color:'#fff',textAlign:'center',
                  boxShadow:sel===pos?'0 0 12px gold':'0 2px 4px rgba(0,0,0,0.4)',
                  zIndex:sel===pos?100:pos.r*10+pos.c
                }}>
                  {renderCardContent(card, false)}
                  {acc && <div style={{fontSize:'0.6rem',color:curP.coins >= cc.coinCost ? '#8f8' : '#f88'}}>({cc.coinCost}üí∞)</div>}
                </div>
              );
            })}
          </div>
        </div>

        {sel && !game.winner && !ageComplete && !isAITurn && (
          <div style={{background:'rgba(139,105,20,0.4)',border:'3px solid gold',borderRadius:'8px',padding:'15px'}}>
            {wonderMode ? <div>
              <div style={{marginBottom:'10px'}}><strong>Build Wonder:</strong> {wonderMode.name}<br/><span style={{fontSize:'0.85rem'}}>Using: {sel.card.name}</span></div>
              <div style={{display:'flex',gap:'8px'}}>
                <button onClick={buildWonder} style={{padding:'10px 20px',background:'#808',border:'2px solid #f4e4c1',borderRadius:'5px',color:'#fff',fontWeight:'bold',cursor:'pointer'}}>‚úì Build Wonder</button>
                <button onClick={() => setWonderMode(null)} style={{padding:'10px 20px',background:'#8b4513',border:'2px solid #f4e4c1',borderRadius:'5px',color:'#fff',fontWeight:'bold',cursor:'pointer'}}>‚úï Cancel</button>
              </div>
            </div> : <div>
              <div style={{marginBottom:'8px'}}><strong>Selected:</strong> {sel.card.name}<span style={{marginLeft:'10px',fontSize:'0.85rem',color:'#c9a227'}}>{calcCost(sel.card.cost, curProd, oppProd).details}</span></div>
              <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
                <button onClick={buildCard} style={{padding:'10px 20px',background:'#228b22',border:'2px solid #f4e4c1',borderRadius:'5px',color:'#fff',fontWeight:'bold',cursor:'pointer'}}>‚úì Build</button>
                <button onClick={discardCard} style={{padding:'10px 20px',background:'#666',border:'2px solid #f4e4c1',borderRadius:'5px',color:'#fff',fontWeight:'bold',cursor:'pointer'}}>Discard +{2 + yellowCount}üí∞</button>
                <button onClick={() => setSel(null)} style={{padding:'10px 20px',background:'#8b4513',border:'2px solid #f4e4c1',borderRadius:'5px',color:'#fff',fontWeight:'bold',cursor:'pointer'}}>‚úï Cancel</button>
              </div>
              <div style={{marginTop:'8px',fontSize:'0.8rem',color:'#c9a227'}}>Or click a Wonder to build it with this card</div>
            </div>}
          </div>
        )}

        {ageComplete && game.age < 3 && (
          <div style={{background:'rgba(201,162,39,0.3)',border:'3px solid gold',borderRadius:'8px',padding:'25px',textAlign:'center',marginTop:'15px'}}>
            <h2 style={{margin:'0 0 10px 0'}}>Age {game.age} Complete!</h2>
            <p style={{margin:'0 0 15px 0'}}>{vsAI ? 'You' : 'P1'}: {getPts(game.p1)}‚òÖ | {vsAI ? 'AI' : 'P2'}: {getPts(game.p2)}‚òÖ</p>
            <button onClick={startNextAge} style={{padding:'12px 30px',fontSize:'1.1rem',background:'linear-gradient(135deg,#8b6914,#c9a227)',border:'2px solid #f4e4c1',borderRadius:'6px',color:'#2c1810',fontWeight:'bold',cursor:'pointer'}}>Begin Age {game.age + 1} ‚Üí</button>
          </div>
        )}

        {(game.winner || (ageComplete && game.age === 3)) && (
          <div style={{background:'rgba(201,162,39,0.3)',border:'3px solid gold',borderRadius:'8px',padding:'25px',textAlign:'center',marginTop:'15px'}}>
            <h2 style={{margin:'0 0 10px 0'}}>{game.winner ? 'Military Victory!' : 'Game Over!'}</h2>
            <div style={{marginBottom:'15px'}}>
              <p style={{margin:'5px 0'}}>{vsAI ? 'You' : 'Player 1'}: {getPts(game.p1)}‚òÖ {game.military > 0 ? `+ ${getMilPts(game.military)} military` : ''} = {getPts(game.p1) + (game.military > 0 ? getMilPts(game.military) : 0)} total</p>
              <p style={{margin:'5px 0'}}>{vsAI ? 'AI' : 'Player 2'}: {getPts(game.p2)}‚òÖ {game.military < 0 ? `+ ${getMilPts(game.military)} military` : ''} = {getPts(game.p2) + (game.military < 0 ? getMilPts(game.military) : 0)} total</p>
            </div>
            {game.winner ? <p style={{color:'gold',fontSize:'1.2rem'}}>{vsAI ? (game.winner === 1 ? 'You win' : 'AI wins') : `Player ${game.winner} wins`} by military supremacy!</p> : <p style={{color:'gold',fontSize:'1.2rem'}}>{(() => {
              const p1Total = getPts(game.p1) + (game.military > 0 ? getMilPts(game.military) : 0);
              const p2Total = getPts(game.p2) + (game.military < 0 ? getMilPts(game.military) : 0);
              if (p1Total > p2Total) return vsAI ? 'You win!' : 'Player 1 wins!';
              if (p2Total > p1Total) return vsAI ? 'AI wins!' : 'Player 2 wins!';
              return "It's a tie!";
            })()}</p>}
            <button onClick={() => setGame(null)} style={{padding:'12px 30px',fontSize:'1.1rem',background:'linear-gradient(135deg,#8b6914,#c9a227)',border:'2px solid #f4e4c1',borderRadius:'6px',color:'#2c1810',fontWeight:'bold',cursor:'pointer',marginTop:'10px'}}>Play Again</button>
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
